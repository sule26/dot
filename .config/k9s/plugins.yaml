plugins:
  # Gonzo
  gonzo:
    shortCut: Ctrl-L
    description: 'Gonzo log analysis'
    scopes:
      - po
    command: sh
    background: false
    args:
      - -c
      - 'kubectl logs -f --tail=0 $NAME -n $NAMESPACE --context $CONTEXT | gonzo'
  # Cert-Manager
  cert-status:
    shortCut: Shift-S
    confirm: false
    description: Certificate status
    scopes:
      - certificates
    command: bash
    background: false
    args:
      - -c
      - 'cmctl status certificate --context $CONTEXT -n $NAMESPACE $NAME |& less'
  # cert-renew:
  #   shortCut: Shift-R
  #   confirm: false
  #   description: Certificate renew
  #   scopes:
  #     - certificates
  #   command: bash
  #   background: false
  #   args:
  #     - -c
  #     - 'cmctl renew --context $CONTEXT -n $NAMESPACE $NAME |& less'
  secret-inspect:
    shortCut: Shift-I
    confirm: false
    description: Inspect secret
    scopes:
      - secrets
    command: bash
    background: false
    args:
      - -c
      - 'cmctl inspect secret --context $CONTEXT -n $NAMESPACE $NAME |& less'
  # EKS-NODE-VIEWER
  eks-node-viewer:
    shortCut: Shift-X
    description: 'eks-node-viewer'
    scopes:
      - node
    background: false
    command: bash
    args:
      - -c
      - |
        env $(kubectl config view --context $CONTEXT --minify -o json | jq -r ".users[0].user.exec.env[] | select(.name == \"AWS_PROFILE\") | \"AWS_PROFILE=\" + .value" && kubectl config view --context $CONTEXT --minify -o json | jq -r ".users[0].user.exec.args | \"AWS_REGION=\" + .[1]") eks-node-viewer --context $CONTEXT --resources cpu,memory --extra-labels karpenter.sh/nodepool,eks-node-viewer/node-age --node-sort=creation=dsc
  # External-Secrets
  refresh-external-secrets:
    shortCut: Shift-R
    confirm: false
    scopes:
      - externalsecrets
    description: Refresh the externalsecret
    command: bash
    background: true
    args:
      - -c
      - 'kubectl annotate externalsecrets.external-secrets.io --context $CONTEXT -n $NAMESPACE $NAME force-sync=$(date +%s) --overwrite'
  refresh-push-secrets:
    shortCut: Shift-R
    confirm: false
    scopes:
      - pushsecrets
    description: Refresh the pushsecret
    command: bash
    background: true
    args:
      - -c
      - 'kubectl annotate pushsecrets.external-secrets.io --context $CONTEXT -n $NAMESPACE $NAME force-sync=$(date +%s) --overwrite'
  # Helm Default Values
  helm-default-values:
    shortCut: Shift-V
    confirm: false
    description: Chart Default Values
    scopes:
      - helm
    command: sh
    background: false
    args:
      - -c
      - >-
        revision=$(helm history -n $NAMESPACE --kube-context $CONTEXT $COL-NAME | grep deployed | cut -d$'\t' -f1 | tr -d ' \t');
        kubectl
        get secrets
        --context $CONTEXT
        -n $NAMESPACE
        sh.helm.release.v1.$COL-NAME.v$revision -o yaml
        | yq e '.data.release' -
        | base64 -d
        | base64 -d
        | gunzip
        | jq -r '.chart.values'
        | yq -P
        | less -K
  # Helm Diff
  helm-diff-previous:
    shortCut: Shift-D
    confirm: false
    description: Diff with Previous Revision
    scopes:
      - helm
    command: bash
    background: false
    args:
      - -c
      - >-
        LAST_REVISION=$(($COL-REVISION-1));
        helm diff revision $COL-NAME $COL-REVISION $LAST_REVISION --kube-context $CONTEXT --namespace $NAMESPACE --color | less -RK
  helm-diff-current:
    shortCut: Shift-Q
    confirm: false
    description: Diff with Current Revision
    scopes:
      - history
    command: bash
    background: false
    args:
      - -c
      - >-
        RELEASE_NAME=$(echo $NAME | cut -d':' -f1);
        LATEST_REVISION=$(helm history -n $NAMESPACE --kube-context $CONTEXT $RELEASE_NAME | grep deployed | cut -d$'\t' -f1 | tr -d ' \t');
        helm diff revision $RELEASE_NAME $LATEST_REVISION $COL-REVISION --kube-context $CONTEXT --namespace $NAMESPACE --color | less -RK
  # Helm Values
  helm-values:
    shortCut: v
    confirm: false
    description: Values
    scopes:
      - helm
    command: sh
    background: false
    args:
      - -c
      - 'helm get values $COL-NAME -n $NAMESPACE --kube-context $CONTEXT | less -K'
  # JQ Logs
  jqlogs:
    shortCut: Ctrl-J
    confirm: false
    description: 'Logs (jq)'
    scopes:
      - po
    command: kubectl
    background: false
    args:
      - jq
      - $NAME
      - $NAMESPACE
      - $CONTEXT
